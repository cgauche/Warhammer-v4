<script>
    var Helper = {
        googleURL: 'https://script.google.com/macros/s/AKfycbxHJ0GVjpaLe0fj9swl41j_dC0MNLl2U3MatuPS_q7IcJCZ7VNiBWTL68fYz2imhlQ8gQ/exec',
        dice: function (value, callbackBegin, callback, callbackEnd, auto) {
            var oThat = this;
            var $die = $('.die')
            var $die1 = $('#die1');
            var $die10 = $('#die10');
            var $dices_modal = $('#dices_modal');
            var values = Array.isArray(value) ? value : [value];
            var timeoutId,
                animationDuration = 1000

            this.reset = function () {
                $die.attr('data-face', null).removeClass('rolling')
            }

            this.rollTo = function (values, i) {
                clearTimeout(timeoutId)
                var face = values[i];
                if (Array.isArray(face)) {
                    var die1 = face[0];
                    var die2 = face[1];
                } else {
                    die1 = face % 10;
                    die2 = Math.floor(face / 10);
                }
                $die1.attr('data-face', die1)
                $die10.attr('data-face', die2)
                callback(i++);
                timeoutId = setTimeout(function () {
                    if (values.length <= i) {
                        $dices_modal.removeClass('modal');
                        $dices_modal.fadeOut("slow", "linear");
                        if (typeof callbackEnd !== 'undefined') {
                            callbackEnd();
                        }
                    } else {
                        oThat.init(values, i);
                    }
                }, animationDuration)
            };
            this.roll = function (values, i) {
                $die.addClass('rolling')
                clearTimeout(timeoutId)

                timeoutId = setTimeout(function () {
                    $die.removeClass('rolling')
                    oThat.rollTo(values, i)
                }, animationDuration)

                return false
            };

            this.init = function (values, i) {
                this.reset();
                if (typeof callbackBegin !== 'undefined') {
                    callbackBegin(i);
                }
                if (typeof auto !== 'undefined' && auto) {
                    timeoutId = setTimeout(function () {
                        oThat.roll(values, i);
                    }, 1000)
                } else {
                    $dices_modal.click(function () {
                        $dices_modal.off('click');
                        oThat.roll(values, i);
                        return false
                    });
                }
            }
            $dices_modal.addClass('modal');
            $dices_modal.fadeIn('slow');
            this.init(values, 0);

            return this;
        },
        ajaxLoader: function (el, options) {
            // Becomes this.options
            var defaults = {
                bgColor: '#fff', // Defines the color of the layer
                ldColor: '#000', // Defines the color of the loader
                duration: 800,
                opacity: 0.7, // Defines the opacity of the layer if one 
                classOveride: false,
                layer: true, // Defines if there will be a layer or not
                size: '2.5em' // Size of the loader
            };
            this.options = jQuery.extend(defaults, options);
            this.container = $(el);

            this.init = function () {
                var container = this.container;
                // Delete any other loaders
                this.remove();
                // Create the overlay
                var overlay = $('<section></section>').css({
                    'background-color': this.options.bgColor,
                    'opacity': this.options.opacity,
                    'z-index': 999
                }).addClass('ajax_loader');
                var loader = $('<div class="loader" style="height:' + this.options.size + ';width:' + this.options.size + '">' +
                    '<div class="ldr-blk an_delay one" style="background-color:' + this.options.ldColor + '"></div>' +
                    '<div class="ldr-blk an_delay two" style="background-color:' + this.options.ldColor + '"></div>' +
                    '<div class="ldr-blk an_delay three" style="background-color:' + this.options.ldColor + '"></div>' +
                    '<div class="ldr-blk an_delay four" style="background-color:' + this.options.ldColor + '"></div>' +
                    '</div>');
                if (this.options.layer) {
                    overlay.append(loader);
                } else {
                    overlay = loader.addClass('ajax_loader');
                }
                // add an overiding class name to set new loader style
                if (this.options.classOveride) {
                    overlay.addClass(this.options.classOveride);
                }
                // insert overlay and loader into DOM
                container.append(overlay).fadeIn(this.options.duration);
            };

            this.remove = function (callback) {
                var overlay = this.container.children(".ajax_loader");
                if (overlay.length) {
                    overlay.fadeOut(this.options.classOveride, function () {
                        overlay.remove();
                        if (typeof callback === "function")
                            callback();
                    });
                }
            };

            this.init();
        },
        executeHelperFunction: function (el, CharGen) {
            el.find('[data-execute]').each(function () {
                var el = $(this);
                var par = el.data('execute').split('|');
                if (par.length > 1) {
                    Helper[par[0]](el, par, CharGen);
                } else {
                    Helper[par[0]](el, CharGen);
                }
            });
        },
        addDescription: function (message, CharGen, force) {
            if ($('.right_panel:visible').length) {
                var description = $('.right_panel:visible').html("<div class='description'>" + message + "</div>");
                Helper.executeHelperFunction(description, CharGen);
                if (description.find('.tabs').length) {
                    description.find('.tabs').tabs({active: description.find('.tabs').data('active')});
                }
            } else if (force === true) {
                this.showPopin('', message, CharGen);
            }
        },
        showPopin: function (title, message, CharGen) {
            var modal = $('#help_modal');
            var description = modal.find('.help_panel')
            if (message) {
                modal.show();
                description.html("<div class='description'>" + message + "</div>");
                Helper.executeHelperFunction(description, CharGen);
                if (description.find('.tabs').length) {
                    description.find('.tabs').tabs({active: description.find('.tabs').data('active')});
                }
            } else {
                modal.hide()
                description.html('');
            }
        },
        uniqid: function () {
            return (new Date().getTime() + Math.floor((Math.random() * 10000) + 1)).toString(16);
        },
        getHelpFormat: function (el) {
            var result = '';
            var flex = false;
            if (typeof el.careerGroup !== 'undefined') {
                el = {altDesc: el.altDesc, desc: {...el.desc, ...el.getCareer().desc}}
            }
            var desc = typeof el.getDescription !== 'undefined' ? el.getDescription() :  el.desc;
            if (desc) {
                flex = true;
                var part2 = '';
                var tmp = desc;
                var i = 0;
                var tabActif = 0;
                if (typeof tmp.tab_actif !== 'undefined') {
                    tabActif = tmp.tab_actif;
                    tmp = Helper.clone(tmp);
                    delete tmp.tab_actif;
                }
                var prefix = Helper.uniqid();
                for (var key in tmp) {
                    if (tmp.hasOwnProperty(key)) {
                        var data = tmp[key] && tmp[key][0] === '#' ? 'data-execute="' + tmp[key].substring(1) + '"' : '';
                        part2 += '<div id="tabs-' + prefix + i++ + '" class="pretty_panel overflow_panel"' + data + '><br>' + (data ? '' : tmp[key]) + '</div>';
                    }
                }

                var style = 'style="flex:' + (100 / i - 1).toPrecision(2) + '%"';
                var part1 = '<ul>';
                i = 0;
                for (key in tmp) {
                    if (tmp.hasOwnProperty(key)) {
                        part1 += '<li ' + style + '><a href="#tabs-' + prefix + i++ + '">' + key + '</a></li>';
                    }
                }
                part1 += '</ul>';

                result = '<div style="height: 1%" class="tabs" data-active="' + tabActif + '">' + part1 + part2 + '</div>';
            } else {
                result = desc;
            }
            return '<span ' + (flex ? 'class="title"' : '') + '><h3>' + (typeof el.altDesc !== 'undefined' ? el.altDesc : (typeof el.getLabel !== 'undefined' ? el.getLabel() : el.label)) + '</h3>' + result + '</span>';
        },
        removePlural: function (text) {
            return text.replace(/(s|es|e)\b/ig, '');
        },
        toId: function (text) {
            if (!text) {
                return text;
            }
            return text.toLowerCase().replace(/[éêè]/ig, 'e').replace(/[áâà]/ig, 'a').replace('  ', ' ').replace('œ', 'oe');
        },
        getRandomInt: function (max) {
            return Math.floor(1 + Math.random() * Math.floor(max));
        },
        sort: function (array) {
            array.sort(function (a, b) {
                if (a.data.type !== b.data.type) {
                    return a.data.type === 'base' ? -1 : 1;
                }
                return a.getLabel() > b.getLabel() ? 1 : -1
            });
            return array;
        },
        getXPCost: function (elem, oldValue, newValue) {
            var type = elem.getType();
            var total = 0;
            while (oldValue !== newValue) {
                if (type === 'skill') {
                    if (newValue <= 5) {
                        total += 10;
                    } else if (newValue <= 10) {
                        total += 15;
                    } else if (newValue <= 15) {
                        total += 20;
                    } else if (newValue <= 20) {
                        total += 30;
                    } else if (newValue <= 25) {
                        total += 40;
                    } else if (newValue <= 30) {
                        total += 60;
                    } else if (newValue <= 35) {
                        total += 80;
                    } else if (newValue <= 40) {
                        total += 110;
                    } else if (newValue <= 45) {
                        total += 140;
                    } else if (newValue <= 50) {
                        total += 180;
                    } else if (newValue <= 55) {
                        total += 220;
                    } else if (newValue <= 60) {
                        total += 270;
                    } else if (newValue <= 65) {
                        total += 320;
                    } else if (newValue <= 70) {
                        total += 380;
                    }
                } else if (type === 'characteristic') {
                    if (newValue <= 5) {
                        total += 25;
                    } else if (newValue <= 10) {
                        total += 30;
                    } else if (newValue <= 15) {
                        total += 40;
                    } else if (newValue <= 20) {
                        total += 50;
                    } else if (newValue <= 25) {
                        total += 70;
                    } else if (newValue <= 30) {
                        total += 90;
                    } else if (newValue <= 35) {
                        total += 120;
                    } else if (newValue <= 40) {
                        total += 150;
                    } else if (newValue <= 45) {
                        total += 190;
                    } else if (newValue <= 50) {
                        total += 230;
                    } else if (newValue <= 55) {
                        total += 280;
                    } else if (newValue <= 60) {
                        total += 330;
                    } else if (newValue <= 65) {
                        total += 390;
                    } else if (newValue <= 70) {
                        total += 450;
                    }
                } else if (type === 'talent') {
                    if (elem.magic === 'Magie du Chaos') {
                        total += 100;
                    } else {
                        total += newValue * 100;
                    }
                } else if (type === 'spell') {
                    if (elem.magic === 'Invocation') {
                        total += (newValue - 1) * 100;
                    } else if (elem.magic === 'Magie des Arcanes') {
                        total += Math.ceil(newValue / elem.max) * 100;
                    }
                }
                if (elem.reduced) {
                    total -= elem.reduced;
                }
                newValue--;
            }
            return total;
        },
        generateNormalList: function (list, filter, onChange, el, CharGen) {
            el = typeof el !== 'undefined' ? el : $('.left_panel');
            return Helper.generateListWithHelp(list, filter, el, function (i, el) {
                return typeof el.altLabel !== 'undefined' ? el.altLabel : el.getLabel()
            }, function (i, el, disabled, force) {
                Helper.addDescription(Helper.getHelpFormat(el), CharGen, force);
                if (!disabled) {
                    onChange(i, el);
                }
            }, false, null, function (i, e) {
                if (typeof e.level != 'undefined') {
                    return e.level;
                }
                return e;
            });
        },
        generateMenu: function (list, index, el, onClick, isDisabled, filter) {
            var html = '<div class="steplist">';
            $(list).each(function (i, e) {
                var elIsDisabled = e.isDisabled ? e.isDisabled(i, e) : (isDisabled ? isDisabled(i, e) : false);
                if (e.filter ? e.filter(i, e) : (filter ? filter(i, e) : true)) {
                    html += '<button class="ui-button ui-widget button" data-line="' + i + '" ' + (elIsDisabled ? 'disabled' : '') + ' >' + e.stepName + '</button>';
                }
            });
            html += '</div>';
            el.html(html);
            var steplist = $('.steplist');
            $(steplist).find('button').off('click').on('click', function () {
                var i = $(this).data('line');
                var el = list[i];
                if (el.onClick) {
                    el.onClick(i, el);
                } else if (onClick) {
                    onClick(i, el);
                }
            });
            return list;
        },
        organizeTable: function (td, i, line, lines, horizontal) {
            if (horizontal) {
                if (typeof lines[i] === 'undefined') {
                    lines[i] = '';
                }
                lines[i] += td;
            } else {
                line += td;
            }
            return line;
        },
        generateListWithRankAndHelp: function (elems, header, filter, el, funcsLabel, funcsUpDown, funcOnChange, funcClickLine, append, funcsMoveUpDown, horizontal) {
            var id = 'selectable' + Helper.uniqid();
            var count = $(header).length;
            var html = '<table class="selectable ' + (count > 2 ? 'rank' : '') + '" id="' + id + '">';
            var displayedElems = [];
            var lines = [];
            var line = '';
            var td;
            horizontal = typeof horizontal !== 'undefined' && horizontal === true;

            var style = '';
            if (horizontal) {
                style = 'style="width:' + (100 / elems.length - 1).toPrecision(2) + '%"';
            }

            $(header).each(function () {
                td = '<td ' + style + '>' + this + '</td>';
                line = Helper.organizeTable(td, lines.length, line, lines, horizontal);
            });
            if (!horizontal) {
                lines[lines.length] = line;
                line = '';
            }
            $.each(elems, function (i) {
                if (filter(i, this)) {
                    displayedElems[i] = this;
                    var y = 0;
                    var x = 0;
                    td = '<td ' + style + ' data-line="' + i + '" data-id="' + this.id + '" class="label ui-widget-content">' + funcsLabel[y++](i, this) + '</td>';
                    line = Helper.organizeTable(td, x++, line, lines, horizontal);
                    if (count >= 4) {
                        td = '<td ' + style + ' data-line="' + i + '" data-id="' + this.id + '" class="base">' + funcsLabel[y++](i, this) + '</td>';
                        line = Helper.organizeTable(td, x++, line, lines, horizontal);
                    }
                    td = '<td ' + style + ' data-line="' + i + '" data-id="' + this.id + '" class="modif">';
                    if (append) {
                        line = Helper.organizeTable(td + funcsLabel[y++](i, this) + '</td>', x++, line, lines, horizontal);
                    } else {
                        if (count > 2) {
                            td += '<button class="down"><</button>';
                            if (funcsMoveUpDown) {
                                td += '<button class="movedown">&darr;</button>';
                            }
                            td += '<input class="number" type="text" disabled value="' + funcsLabel[y++](i, this) + '" />';
                            if (funcsMoveUpDown) {
                                td += '<button class="moveup">&uarr;</button>';
                            }
                            td += '<button class="up">></button>';
                        } else {
                            td += funcsLabel[y++](i, this);
                        }
                        line = Helper.organizeTable(td + '</td>', x++, line, lines, horizontal);
                        while (y < count - 1) {
                            td = '<td ' + style + ' data-line="' + i + '" data-id="' + this.id + '">' + funcsLabel[y++](i, this) + '</td>';
                            line = Helper.organizeTable(td, x++, line, lines, horizontal);
                        }
                    }
                    if (count > 2) {
                        td = '<td ' + style + ' class="total">' + funcsLabel[y++](i, this) + '</td>'
                        line = Helper.organizeTable(td, x++, line, lines, horizontal);
                    }
                    if (!horizontal) {
                        lines[lines.length] = line;
                        line = '';
                    }
                }
            });
            html += '<tr>' + lines.join('</tr></tr>') + '</tr></table>';
            el.append(html);
            var select = $('#' + id);
            if (horizontal) {
                line = select.find("tr:first-child td[data-line]");
            } else {
                line = select.find("tr td[data-line]:first-child");
            }
            line.off('click').on('click', function () {
                var index = $(this).data('line');
                funcClickLine(index, elems[index]);
            });
            select.find('button.up,button.down').off('click').on('click', function () {
                var index = $(this).parents("td").data('line');
                var $el = $(this).parents("td").find('input.number');
                funcsUpDown(index, elems[index], $(this).hasClass('up') ? 1 : -1, $el)
                $el.trigger('change');
            });
            select.find('button.moveup,button.movedown').off('click').on('click', function () {
                var $el = $(this).parents("tr").find('input.number');
                var $el2 = $(this).hasClass('moveup') ? $el.parents('tr').prev().find('input.number') : $el.parents('tr').next().find('input.number');
                funcsMoveUpDown($el, $el2)
                $el.trigger('change');
                $el2.trigger('change');
            });
            select.find('input.number').off('change').on('change', function () {
                var index = $(this).parents("td").data('line');
                funcOnChange(index, elems[index], displayedElems, $(this).parents("tr").find('.total'));
            });
            return select;
        },
        generateListWithHelp: function (elems, filter, el, funcLabel, funcHelp, append, funDisabled, funcLevel, custom, showHelp) {
            var id = 'selectable' + Helper.uniqid();
            var html = '<ol class="selectable" id="' + id + '">';
            elems = typeof custom !== 'undefined' && custom ? [].concat(elems, ['custom']) : elems;
            $(elems).each(function (i, el) {
                if (filter(i, el)) {
                    var disabled = '';
                    if (funDisabled && funDisabled(i, el)) {
                        disabled = 'disabled';
                    }
                    var level = '';
                    if (funcLevel) {
                        level = 'listchild' + funcLevel(i, el);
                    }
                    html += '<li data-line="' + i + '" data-id="' + el.id + '" class="ui-widget-content ' + disabled + ' ' + level + '">';
                    if (funcHelp && (typeof showHelp === 'undefined' || showHelp(i, el))) {
                        html += '<buttom class="popin_help for_mobile"></buttom>';
                    }
                    html += funcLabel(i, el) + '</li>';
                }
            });
            html += '</ol>';
            if (append) {
                el.append(html);
            } else {
                el.html(html);
            }
            var select = $('#' + id);

            select.off("click", 'li').on('click', 'li', function () {
                var $el = $(this);
                var i = $el.data('line');
                if (append !== true && !$el.is('.disabled')) {
                    select.find('li.ui-selected').removeClass('ui-selected');
                    $el.addClass('ui-selected');
                }
                if (funcHelp) {
                    funcHelp(i, elems[i], $el.is('.disabled'));
                }
                return false;
            });
            select.off("click", '.popin_help').on('click', '.popin_help', function () {
                var $el = $(this).parent('li');
                var i = $el.data('line');
                funcHelp(i, elems[i], $el.is('.disabled'), true);
                return false;
            })
            $(el).animate({
                scrollTop: 0
            });
            return select;
        },
        scrollToElement: function (el, container) {
            container.stop(true);
            var conOffset = container.offset();
            var offset = el.offset();
            if (conOffset && offset) {
                container.animate({
                    scrollTop: offset.top - conOffset.top + container.scrollTop()
                });
            }
        },
        rangToImg: function (rank) {
            var icon = 'icon '
            if (rank === 1) {
                icon += 'cross_icon';
            } else if (rank === 2) {
                icon += 'sword_icon'
            } else if (rank === 3) {
                icon += 'skull_icon'
            } else if (rank === 4) {
                icon += 'shield_icon'
            }
            return '<div class="' + icon + '"></div>'
        },
        generateListWithHelpPopin: function (elems, filter, el, left, funcLabel, funDisabled, funcHelp, funcAdd, showHelp) {
            var id = 'selectable' + Helper.uniqid();
            var html = '<ol class="selectable" id="' + id + '">';
            $(elems).each(function (i, el) {
                if (filter(i, el)) {
                    var disabled = '';
                    if (funDisabled && funDisabled(i, el)) {
                        disabled = 'disabled';
                    }
                    html += '<li data-line="' + i + '" data-id="' + el.id + '" class="ui-widget-content ' + disabled + '">';
                    if (left) {
                        html += '<div><buttom class="add" style="' + (disabled ? 'visibility:hidden' : '') + '"><</buttom></div>';
                    }
                    html += '<div>';
                    if (!showHelp || showHelp(i, el)) {
                        html += '<buttom class="popin_help">?</buttom>';
                    }
                    html += funcLabel(i, el) + '</div><div style="order: 2;margin-left: auto">';
                    if (!left) {
                        html += '<buttom class="add" style="' + (disabled ? 'visibility:hidden' : '') + '">></buttom>';
                    }
                    html += '</div></li>';
                }
            });
            html += '</ol>';
            el.append(html);
            var $select = $('#' + id);

            $select.find('.popin_help').off("click").on('click', function () {
                var i = $(this).parents('li').data('line');
                funcHelp(i, elems[i]);
                return false;
            });
            $select.find('.add').off("click").on('click', function () {
                var i = $(this).parents('li').data('line');
                funcAdd(i, elems[i]);
            });
            return $select;
        },
        formatSkill: function (CharGen, text) {
            return Helper.formatComplexElem(CharGen, text, 'skill');
        },
        formatTalent: function (CharGen, text) {
            return Helper.formatComplexElem(CharGen, text, 'talent');
        },
        formatSpell: function (CharGen, text) {
            return Helper.formatComplexElem(CharGen, text, 'spell');
        },
        formatComplexElem: function (CharGen, text, type) {
            var string = text.split('(');
            var spec = '';
            var majType = type[0].toUpperCase() + type.substring(1);
            text = string[0].trim();
            var elem = Helper.clone(CharGen['all' + majType + 's'][Helper.toId(text)]);
            if (!elem) {
                return false;
            }
            var displayedSpec = '';
            if (string.length > 1) {
                displayedSpec = string[1].split(')')[0];
                spec = displayedSpec.replace(/ ou /g, ', ');
            }
            if (elem.specName !== spec && spec !== 'Au choix') {
                elem.specs = spec;
                string = spec.split(', ');
                if (string.length === 1 && spec) {
                    elem.spec = spec;
                } else {
                    elem.specName = displayedSpec;
                }
            }
            elem.getType = function () {
                return type
            };
            return elem;
        },
        merge: function (el, char) {
            for (var key in el) {
                if (el.hasOwnProperty(key)) {
                    char[key] = el[key];
                }
            }
        },
        isFunction: function (obj) {

            // Support: Chrome <=57, Firefox <=52
            // In some browsers, typeof returns "function" for HTML <object> elements
            // (i.e., `typeof document.createElement( "object" ) === "function"`).
            // We don't want to classify *any* DOM node as a function.
            return typeof obj === "function" && typeof obj.nodeType !== "number";
        },
        extend: function () {
            var options, name, src, copy, copyIsArray, clone,
                target = arguments[0] || {},
                i = 1,
                length = arguments.length,
                deep = false;

            // Handle a deep copy situation
            if (typeof target === "boolean") {
                deep = target;

                // Skip the boolean and the target
                target = arguments[i] || {};
                i++;
            }

            // Handle case when target is a string or something (possible in deep copy)
            if (typeof target !== "object" && !Helper.isFunction(target)) {
                target = {};
            }

            // Extend jQuery itself if only one argument is passed
            if (i === length) {
                target = this;
                i--;
            }

            for (; i < length; i++) {

                // Only deal with non-null/undefined values
                if ((options = arguments[i]) != null) {

                    // Extend the base object
                    for (name in options) {
                        src = target[name];
                        copy = options[name];

                        // Prevent never-ending loop
                        if (target === copy) {
                            continue;
                        }

                        // Recurse if we're merging plain objects or arrays
                        if (deep && copy && (Helper.isPlainObject(copy) ||
                            (copyIsArray = Array.isArray(copy)))) {

                            if (copyIsArray) {
                                copyIsArray = false;
                                clone = src && Array.isArray(src) ? src : [];

                            } else {
                                clone = src && Helper.isPlainObject(src) ? src : {};
                            }

                            // Never move original objects, clone them
                            target[name] = Helper.extend(deep, clone, copy);

                            // Don't bring in undefined values
                        } else if (copy !== undefined) {
                            target[name] = copy;
                        }
                    }
                }
            }

            // Return the modified object
            return target;
        },
        isPlainObject: function (obj) {
            var proto, Ctor;

            // Detect obvious negatives
            // Use toString instead of jQuery.type to catch host objects
            if (!obj || toString.call(obj) !== "[object Object]") {
                return false;
            }

            proto = Object.getPrototypeOf(obj);

            // Objects with no prototype (e.g., `Object.create( null )`) are plain
            if (!proto) {
                return true;
            }
            var class2type = {}
            var elems = "Boolean Number String Function Array Date RegExp Object Error Symbol".split(" ");
            for (var i = 0; i < elems.length; ++i) {
                var el = elems[i];
                class2type["[object " + el + "]"] = el.toLowerCase();
            }

            // Objects with prototype are plain iff they were constructed by a global Object function
            Ctor = class2type.hasOwnProperty.call(proto, "constructor") && proto.constructor;
            return typeof Ctor === "function" && class2type.hasOwnProperty.toString.call(Ctor) === class2type.hasOwnProperty.toString.call(Object);
        },
        clone: function (el) {
            if (el) {
                return Helper.extend(true, {}, el);
            }
            return null;
        },
        initPopin: function () {
            Helper.popin = $("#dialog").dialog({
                autoOpen: false,
                width: 500
            })
        },
        randomSpecialisation: function (character, allValls, el, index, oldValue, number) {
            if (oldValue === 0) {
                if (el.specs && !el.spec) {
                    var specs = el.specs.split(', ')
                    while (specs.length) {
                        var i = Helper.getRandomInt(specs.length) - 1;
                        if (character.search(el.id, specs[i], el.getType(), true, el.origins ? el.origins[0] : null)) {
                            specs.splice(i, 1);
                        } else {
                            el.spec = specs[i];
                            break;
                        }
                    }
                    if (!specs.length) {
                        if (allValls) {
                            allValls.splice(index, 1);
                        }
                        return false
                    }
                }
            }
            var veryOldAdvance = el.getTotal();
            el = character.set(el, number);
            if (allValls) {
                allValls[index] = el;
            }
            return veryOldAdvance === el.getTotal() ? el : false;
        },
        showSpecialisationPopin: function (character, elem, change, cancel, withOrigin, type) {
            type = typeof type !== 'undefined' ? type : elem.getType();
            var majType = type[0].toUpperCase() + type.substring(1);
            withOrigin = typeof withOrigin !== 'undefined' ? withOrigin : false;

            Helper.showModelPopin('Spécialisation',
                'Choisissez une spécialisation pour votre ' + majType + ': <div><span class="showHelp" data-type="' + type + 's" data-index="' + (elem.index ? elem.index : elem.data.index) + '">' + elem.getLabel() + '</span></div>',
                function (html) {
                    Helper.generateListWithHelp(
                        elem.specs.split(', '),
                        function () {
                            return true;
                        },
                        html,
                        function (i, el) {
                            if (el === 'custom') {
                                return "<input data-id='custom' type='text' value='' class='ui-widget ui-custom' placeholder='Ou saisissez ici votre Spécialisation'/>"
                            } else {
                                return el
                            }
                        },
                        function (i, el) {
                            var custom = $('.selectable [data-id="custom"]');
                            if (custom.length) {
                                if (custom.parent('.ui-selected').length) {
                                    custom.addClass('ui-selected')
                                } else {
                                    custom.removeClass('ui-selected')
                                }
                            }
                        },
                        2,
                        function (i, el) {
                            if (el !== 'custom') {
                                if (withOrigin) {
                                    return character.search(elem.id, el, type, true, elem.origins ? elem.origins[0] : null, false, false)
                                } else {
                                    return character.search(elem.id, el, type);
                                }
                            }
                        },
                        '',
                        typeof elem.data === 'undefined' || elem.data.specName === 'Au choix',
                        function (i, el) {
                            return false
                        }
                    );
                }, function (el) {
                    var spec = el.find('li.ui-selected');
                    var value = '';
                    if (spec.length) {
                        if (spec.find('[data-id="custom"]').length) {
                            value = spec.find('[data-id="custom"]').val().trim()
                            if (!value) {
                                return false;
                            }
                            elem.specs += ', ' + value;
                            elem.data.specs += ', ' + value;
                        } else {
                            value = spec.html();
                        }
                        elem.spec = value;
                        change(0, elem);
                        return true;
                    }
                    return false;
                },
                cancel
            );
        },
        showSpells: function (CharGen, character, returnAction, validateAction, number, mode, numberSpellToChoose, spec) {
            var spells = CharGen.data.spells;
            var remaining = typeof numberSpellToChoose === 'undefined' || numberSpellToChoose === -1 ? 0 : numberSpellToChoose;
            var charSpells = character.getSpells();
            var currentSpell;
            var tmpNumber = number;
            var xp = false;
            $(charSpells).each(function (i, el) {
                if (el && el.data.type === mode && (!el.spec || typeof spec === 'undefined' || el.spec === spec)) {
                    el.myIndex = i;
                    if (!currentSpell && tmpNumber-- === 0) {
                        currentSpell = el;
                    }
                    --remaining;
                }
            });
            if (numberSpellToChoose === -1) {
                numberSpellToChoose = -remaining;
            }
            if (mode === 'Béni') {
                $('.left_panel').html('');
            } else if (mode === 'Magie mineure' || mode === 'Magie du Chaos') {
                $('.left_panel').html("<div class='description_title'>" + remaining + ' Sorts à choisir' + "</div>");
            } else {
                var used = character.xp.used;
                used += Helper.getXPCost({
                    getType: function () {
                        return 'spell'
                    },
                    magic: mode,
                    max: character.searchCharacteristic('Intelligence').getBonus(),
                    reduced: 0
                }, numberSpellToChoose, numberSpellToChoose - remaining)
                character.xp.tmp_used = used;
                xp = true;
                $('.left_panel').html("<div class='description_title'><span class='experience'>" + (character.xp.max - used) + "</span> Points d\'Expérience à dépenser</div>");
            }
            $('.validate').prop('disabled', true);
            if (!currentSpell) {
                var label = function (i, el) {
                    return el.getLabel();
                };
                var filter = function (i, el) {
                    return el.type === mode && (!el.spec || typeof spec === 'undefined' || el.spec === spec);
                };
                var change = function (i, el) {
                    if (typeof spec !== 'undefined') {
                        el.spec = spec;
                    }
                    character.setSpell(el);
                    Helper.showSpells(CharGen, character, returnAction, validateAction, number + 1, mode, numberSpellToChoose, spec);
                };
                var funcDisabled = function (i, el) {
                    return mode === 'Béni' || (remaining <= 0 && !xp) || character.searchSpell(el.id, spec);
                };
                var initHelp = function (i, el) {
                    Helper.showPopin('', Helper.getHelpFormat(el), CharGen);
                };
                Helper.generateListWithHelpPopin(
                    spells,
                    filter,
                    $('.left_panel'),
                    false,
                    label,
                    funcDisabled,
                    initHelp,
                    change
                );
            } else {
                return Helper.showSpells(CharGen, character, returnAction, validateAction, number + 1, mode, numberSpellToChoose, spec)
            }
            $('.right_panel').html('');
            $('.validate').prop('disabled', mode !== 'Béni' && remaining !== 0 && !xp);
            Helper.generateListWithHelpPopin(
                charSpells,
                function (i, el) {
                    return el && el.data.type === mode && (!el.spec || typeof spec === 'undefined' || el.spec === spec)
                },
                $('.right_panel'),
                true,
                function (i, el) {
                    return el.getLabel()
                },
                function () {
                    return mode === 'Béni';
                },
                function (i, el) {
                    Helper.showPopin('', Helper.getHelpFormat(el.data), CharGen)
                },
                function (i, el) {
                    character.setSpell(null, el.myIndex);
                    Helper.showSpells(CharGen, character, returnAction, validateAction, 0, mode, numberSpellToChoose, spec)
                }
            );

            $('.cancel').off('click').on('click', function () {
                if (mode === 'Béni') {
                    Helper.showGods(CharGen, character, returnAction, validateAction, mode);
                } else {
                    returnAction();
                }
            });

            $('.validate').off('click').on('click', function () {
                validateAction();
            });
        },
        showGods: function (CharGen, character, returnAction, validateAction, mode, nbSpell) {
            $('.right_panel').html('');
            var species = $(CharGen.data.gods);
            var $species = Helper.generateNormalList(species, function () {
                return true
            }, function (i, el) {
                var godTalent = character.searchTalent(mode, '', false);
                godTalent.spec = el.label;
                character.applyTalent();
                $('.validate').prop('disabled', false)
            }, undefined, CharGen);
            var godTalent = character.searchTalent(mode, '', false)
            if (godTalent) {
                $species.find('li[data-id="' + godTalent.spec + '"]').click()
            }

            $('.cancel').off('click').on('click', function () {
                returnAction()
            });

            $('.validate').off('click').on('click', function () {
                var godTalent = character.searchTalent(mode, '', false);
                Helper.showSpells(CharGen, character, returnAction, validateAction, 0, mode, nbSpell, godTalent.spec);
            });
        },
        showMagicColor: function (CharGen, character, returnAction, validateAction, mode, nbSpell, spec) {
            $('.right_panel').html('');
            var species = {};
            if (mode === 'Magie des Arcanes') {
                species = [].concat(CharGen.allLoreByGroup['Magie des couleurs'], CharGen.allLoreByGroup['Autres domaines'], CharGen.allLoreByGroup['Magie noire']);
            } else {
                species = [].concat(CharGen.allLoreByGroup['Magie du Chaos']);
            }
            var $species = Helper.generateNormalList(species, function (i, el) {
                return !spec || el.spec === spec
            }, function (i, el) {
                var magicTalent = character.searchTalent(mode, '', false);
                magicTalent.spec = el.label;
                character.applyTalent();
                $('.validate').prop('disabled', false)
            }, undefined, CharGen);
            var magicTalent = character.searchTalent(mode, spec, true)
            if (magicTalent) {
                $species.find('li[data-id="' + magicTalent.spec + '"]').click()
            }

            $('.cancel').off('click').on('click', function () {
                returnAction()
            });

            $('.validate').off('click').on('click', function () {
                var magicTalent = character.searchTalent(mode, '', false);
                Helper.showSpells(CharGen, character, returnAction, validateAction, 0, mode, nbSpell, magicTalent.spec);
            });
        },
        showMagicSpecialisation: function (CharGen, character, cancelAction, validateAction, magic, elem) {
            var spec = elem.spec;
            if (magic === 'Béni') {
                if (!spec) {
                    Helper.showGods(CharGen, character, cancelAction, validateAction, magic);
                } else {
                    Helper.showSpells(CharGen, character, cancelAction, validateAction, 0, magic, 0, spec);
                }
            } else if (magic === 'Magie mineure') {
                Helper.showSpells(CharGen, character, cancelAction, validateAction, 0, magic, character.searchCharacteristic('Force Mentale').getBonus(), spec);
            } else if (magic === 'Magie des Arcanes') {
                if (!spec || spec === 'Magie des couleurs') {
                    Helper.showMagicColor(CharGen, character, cancelAction, validateAction, magic, -1, spec);
                } else {
                    Helper.showSpells(CharGen, character, cancelAction, validateAction, 0, magic, -1, spec);
                }
            } else if (magic === 'Magie du Chaos') {
                if ((!spec || !elem.specs.includes(spec)) && elem.getAdvance() < 2) {
                    Helper.showMagicColor(CharGen, character, cancelAction, validateAction, magic, elem.getAdvance(), spec);
                } else {
                    Helper.showSpells(CharGen, character, cancelAction, validateAction, 0, magic, elem.getAdvance(), spec);
                }
            } else if (magic === 'Invocation') {
                if (!spec) {
                    Helper.showGods(CharGen, character, cancelAction, validateAction, magic, -1);
                } else {
                    Helper.showSpells(CharGen, character, cancelAction, validateAction, 0, magic, -1, spec);
                }
            }
        },
        randomMagicTalent: function (CharGen, character, talent) {
            var magic = talent.data ? talent.data.addMagic : talent.addMagic;
            if (magic === 'Béni') {
                var gods = CharGen.data.gods;
                var i = Helper.getRandomInt(gods.length) - 1;
                talent.spec = gods[i].label;
            } else {
                if (magic === 'Magie mineure') {
                    var spellsNumber = 0;
                    var numberSpellToChoose = character.searchCharacteristic('Force Mentale').getBonus();
                    var spells = CharGen.data.spells;
                    while (spellsNumber < numberSpellToChoose) {
                        var index = Helper.getRandomInt(spells.length) - 1;
                        var spell = spells[index];
                        if (spell.type === magic && !character.searchSpell(spell.id, spell.spec)) {
                            character.setSpell(spell, spellsNumber);
                            ++spellsNumber;
                        }
                    }
                }
            }
        },
        showSpecieChar: function (el, id, CharGen) {
            Helper.generateListWithRankAndHelp(
                CharGen.data.characteristics,
                ['', 'Base', 'Jet'],
                function (i, el) {
                    return el.class !== ''
                },
                el,
                [
                    function (i, el) {
                        return el.getLabel()
                    },
                    function (i, el) {
                        return el.rand[id[1]];
                    },
                    function (i, el) {
                        return el.class === 'roll' ? '+2d10' : '';
                    }
                ],
                function () {
                },
                function () {
                },
                function (i, el) {
                    Helper.showPopin(el.getLabel(), Helper.getHelpFormat(el), CharGen)
                },
                1
            );
        },
        showModelPopin: function (title, description, html, validateFunction, cancelFunction) {
            var dialog = $("#dialog_modal").dialog({
                title: title,
                autoOpen: true,
                width: 350,
                modal: true,
                buttons: {
                    "Valider": function () {
                        if (validateFunction) {
                            if (!validateFunction($(this))) {
                                return false;
                            }
                        }
                        $(this).dialog('close');
                    },
                    "Annuler": function () {
                        $(this).dialog('close');
                    }
                },
                close: function () {
                    if (cancelFunction) {
                        cancelFunction($(this));
                    }
                }
            });
            dialog.html('');
            if (description) {
                dialog.html("<div class='description'>" + description + "</div>");
            }
            if (typeof html === 'function') {
                html(dialog);
            } else {
                dialog.html(html);
            }
            return dialog;
        },
        getSkills: function (skillList, character, origin) {
            var skill;
            var spec;
            var i;
            var el;
            var secondWave = [];
            var careerSkills = [];
            for (i = 0; i < skillList.length; ++i) {
                el = skillList[i];
                spec = el.spec ? el.spec : el.specs;
                skill = character.searchSkill(el.id, spec, true, '', false, false);
                if (!skill) {
                    secondWave[secondWave.length] = el;
                } else {
                    skill.reduced = 0;
                    skill.added = true;
                    skill.addOrigins([origin]);
                    careerSkills[careerSkills.length] = skill;
                }
            }
            for (i = 0; i < secondWave.length; ++i) {
                el = secondWave[i];
                spec = el.spec ? el.spec : el.specs;
                skill = character.searchSkill(el.id, spec, false, origin, true, false);
                if (!skill && (!el.specs || el.spec)) {
                    skill = character.searchSkill(el.id, spec);
                }
                if (!skill) {
                    skill = character.createSkill(el);
                    if (!el.specs || el.spec) {
                        skill = character.setSkill(skill);
                    }
                }
                skill.reduced = 0;
                skill.added = true;
                skill.addOrigins([origin]);
                careerSkills[careerSkills.length] = skill;
            }
            i = 0;
            while (i < character.skills.length) {
                el = character.skills[i];
                if (typeof (el.added) === 'undefined' && el.hasOrigin(origin) && el.getAdvance() === 0) {
                    character.skills.splice(i, 1);
                } else {
                    ++i;
                }
                delete el.added;
            }

            return careerSkills;
        }
    }
    this.Helper = Helper;
</script>