<script>
    var StepResume = function (number, CharGen) {
        var oThat = {};
        var character;
        oThat.stepName = "Résumé";
        oThat.desc = function () {
            return ''
        };
        oThat.title = function () {
            return 'Resumé'
        };
        oThat.validateAction = true;
        oThat.cancelAction = function () {
            $('.cancel').html('Retour');
            $('.cancel').off('click').on('click', function () {
                $('.left_panel').addClass('overflow_panel');
                $('.left_panel').addClass('pretty_panel');
                CharGen.showMenu();
            });
        };
        oThat.saveAction = function () {
            character.saveAdvance();
            return true;
        };
        oThat.initAction = function () {
            character = CharGen.character.clone();
        };
        oThat.otherAction = function (el) {
            if (CharGen.saveName) {
                el.hide();
                return;
            }
            el.html('Sauvegarder');
            el.on('click', function () {
                CharGen.saveDatabaseCharacter(function (data) {
                    if (data) {
                        if (data !== CharGen.saveName) {
                            CharGen.saveName = data;
                            $("#save").dialog({
                                resizable: false,
                                height: "auto",
                                open: function (event, ui) {
                                    $('.codesave').html(data)
                                },
                                buttons: []
                            });
                            el.hide();
                        } else {
                            alert("Personnage sauvegardé");
                        }
                    } else {
                        alert('Echec de la sauvegarde.');
                    }
                })
            });
        };
        /*oThat.randomAction = function (el) {
            el.html('Export Foundry');
            el.on('click', function () {
                var a = document.createElement("a");
                var foundryChar = FoundryHelper.fullExport(CharGen, character);
                a.href = window.URL.createObjectURL(new Blob([JSON.stringify(foundryChar)], {type: "application/json"}));
                a.download = foundryChar['name'] + ".json";
                a.click();
            })
        };*/

        oThat.show = function () {
            $('.two_part_panel').hide();
            var con = $('.all_panel').html('').show();
//            con.removeClass('overflow_panel');
//            con.removeClass('pretty_panel');
            //tabs.append('<div id="tabs-2" class="pretty_panel overflow_panel"><div style="display: flex;"><div class="left_panel"></div><div class="right_panel"></div></div></div>');
            con.append('<div class="header pretty_panel"></div>');
            var skillstab = con.find('.header');
            /** CHARACTERISTICS **/
            var caracs = character.getCharacteristics();
            Helper.generateListWithRankAndHelp(
                caracs,
                ['', 'Init', 'Aug', 'Cour'],
                function (i, el) {
                    return el.data.class === 'roll'
                },
                skillstab,
                [
                    function (i, el) {
                        return el.data.abr ? el.data.abr : el.getLabel();
                    },
                    function (i, el) {
                        return el.getBase();
                    },
                    function (i, el) {
                        return el.getAdvance() ? el.getAdvance() : '';
                    },
                    function (i, el) {
                        return el.getTotal();
                    }
                ],
                function () {
                },
                function () {
                },
                function (i, el) {
                    Helper.showPopin('', Helper.getHelpFormat(el.data), CharGen)
                },
                1,
                undefined,
                true
            );
            con.append('<div class="tabs"></div>');
            var tabs = con.find('.tabs');
            tabs.append('<ul><li><a href="#tabs-1">Perso</a></li><li><a href="#tabs-6">Compétences/Talents</a></li><li><a href="#tabs-4">Possession</a></li><li><a href="#tabs-5">Sorts</a></li><li><a href="#tabs-7">Expérience</a></li></ul>');
            tabs.append('<div id="tabs-1" class="pretty_panel overflow_panel"><div class="main_div"><div class="left_panel"></div><div class="right_panel"></div></div></div>');
            var specie = tabs.find('#tabs-1 .left_panel');
            var details = CharGen.data.details;
            var career = character.getCareerLevel() ? character.getCareerLevel().getCareer() : '';
            var detailDescription = function (i) {
                return {
                    label: details[i] ? details[i].label : '',
                    value: character.details[i] ? character.details[i] : '',
                    desc: function () {
                        Helper.showPopin('', Helper.getHelpFormat({
                            getLabel: function () {
                                return details[i].label;
                            },
                            desc: (details[i].desc[character.getSpecie().data.refDetail] ? details[i].desc[character.getSpecie().data.refDetail] : details[i].allDesc)
                        }), CharGen)
                    }
                }
            };
            var allDetails = [
                detailDescription(0),
                {
                    label: 'Race',
                    value: character.getSpecie() ? character.getSpecie().getLabel() : '',
                    desc: function () {
                        if (character.getSpecie()) {
                            Helper.showPopin('', Helper.getHelpFormat(character.getSpecie().data), CharGen)
                        }
                    }
                },
                {
                    label: 'Classe', value: career ? career.getClass().getLabel() : '', desc: function () {
                        if (career) {
                            Helper.showPopin('', Helper.getHelpFormat(career.getClass()), CharGen)
                        }
                    }
                },
                {
                    label: 'Carrière', value: career ? career.getLabel() : '', desc: function () {
                        console.log(career)
                        if (career) {
                            Helper.showPopin('', Helper.getHelpFormat(career), CharGen)
                        }
                    }
                },
                {
                    label: 'Niveau de Carrière',
                    value: career ? character.getCareerLevel().getLabel() : '',
                    desc: function () {
                        if (career) {
                            Helper.showPopin('', Helper.getHelpFormat(character.getCareerLevel().data), CharGen)
                        }
                    }
                },
                {
                    label: 'Schéma de Carrière',
                    value: career ? character.getCareerLevel().getLabel() : '',
                    desc: function () {
                        if (career) {
                            Helper.showPopin('', Helper.getHelpFormat(character.getCareerLevel().data), CharGen)
                        }
                    }
                },
                {
                    label: 'Statut', value: career ? character.getCareerLevel().data.status : '', desc: function () {
                    }
                },
                detailDescription(1),
                detailDescription(4),
                detailDescription(3),
                detailDescription(2),
                detailDescription(5),
                detailDescription(6),
                detailDescription(7),
            ]
            $(allDetails).each(function (i, el) {
                specie.append('<div data-id="detail_' + i + '"><b>' + el.label + ':</b> ' + el.value + '</div><br>');
                /*$('[data-id="detail_' + i + '"]').off('click').on('click', function () {
                    el.desc();
                });*/
            });
            /** SKILLS **/
            tabs.append('<div id="tabs-6" class="pretty_panel overflow_panel"><div class="main_div"><div class="left_panel"></div><div class="right_panel"></div></div></div>');
            skillstab = tabs.find('#tabs-6 .left_panel');
            skillstab.append('<h3>Compétences de base</h3>');
            var skills = character.getAllSkills();
            Helper.generateListWithRankAndHelp(
                skills,
                ['Nom', 'Carac', 'Aug', 'Comp'],
                function (i, el) {
                    return el.data.type === 'base' && (!el.spec || el.spec === 'Base')
                },
                skillstab,
                [
                    function (i, el) {
                        return el.getLabel()
                    },
                    function (i, el) {
                        return el.getCharacteristic().data.abr + ' ' + el.getBase();
                    },
                    function (i, el) {
                        return el.getAdvance() ? el.getAdvance() : '';
                    },
                    function (i, el) {
                        return el.getTotal();
                    }
                ],
                function (mode, el) {
                },
                function (t) {
                },
                function (i, el) {
                    Helper.showPopin('', Helper.getHelpFormat(el.data), CharGen)
                },
                1
            );
            skillstab = tabs.find('#tabs-6 .right_panel');
            skillstab.append('<h3>Comp. groupées et avancées</h3>');

            Helper.generateListWithRankAndHelp(
                skills,
                ['Nom', 'Carac', 'Aug', 'Comp'],
                function (i, el) {
                    return !(el.data.type === 'base' && (!el.spec || el.spec === 'Base'))
                },
                skillstab,
                [
                    function (i, el) {
                        return el.getLabel()
                    },
                    function (i, el) {
                        return el.getCharacteristic().data.abr + ' ' + el.getBase();
                    },
                    function (i, el) {
                        return el.getAdvance() ? el.getAdvance() : '';
                    },
                    function (i, el) {
                        return el.getTotal();
                    }
                ],
                function (mode, el) {
                },
                function (t) {
                },
                function (i, el) {
                    Helper.showPopin('', Helper.getHelpFormat(el.data), CharGen)
                },
                1
            );

            /** TALENTS **/
            var talentstab = skillstab;
            talentstab.append('<h3>Talents</h3>');
            character.deleteEmpty();
            var talents = character.getTalents();
            Helper.generateListWithRankAndHelp(
                talents,
                ['Nom', 'Rang', 'Description'],
                function () {
                    return true;
                },
                talentstab,
                [
                    function (i, el) {
                        return el.getLabel()
                    },
                    function (i, el) {
                        var max = el.getMax();
                        return el.getAdvance() + (max ? '/' + max : '');
                    },
                    function (i, el) {
                        return el.data.test;
                    },
                ],
                function (mode, el) {
                },
                function (t) {
                },
                function (i, el) {
                    Helper.showPopin('', Helper.getHelpFormat(el.data), CharGen)
                },
                1
            );

            /** TRAPPINGS **/
            tabs.append('<div id="tabs-4" class="pretty_panel overflow_panel"><div class="main_div"><div class="left_panel"></div><div class="right_panel"></div></div></div>');
            var trappingstab = tabs.find('#tabs-4 .left_panel');
            var trappings = character.trappings;
            Helper.generateListWithHelp(
                trappings,
                function () {
                    return true
                },
                trappingstab,
                function (i, el) {
                    return el
                },
                function (i) {
                    var trapp = CharGen.allTrappings[Helper.toId(Helper.removePlural(trappings[i]))];
                    $('.right_panel').html('');
                    if (typeof trapp !== 'undefined') {
                        if (trapp.desc !== '') {
                            Helper.showPopin('', Helper.getHelpFormat(trapp), CharGen);
                        }
                    }
                },
                true,
                '','','',
                function (i, el) {
                    var trapp = CharGen.allTrappings[Helper.toId(Helper.removePlural(trappings[i]))];
                    return typeof trapp !== 'undefined' && trapp.desc !== '';
                }
            )

            /** GODS **/
            tabs.append('<div id="tabs-5" class="pretty_panel overflow_panel"><div class="main_div"><div class="left_panel"></div><div class="right_panel"></div></div></div>');
            var spellstab = tabs.find('#tabs-5 .left_panel');
            var spells = character.getSpells();
            if (spells) {
                var god = character.getGod();
                if (god) {
                    spellstab.append('<br><div class="gods"><b>Dieu:</b> ' + god.getLabel() + '</div>');
                }
                var magicTalent = character.searchTalent('Magie des Arcanes', '', false)
                if (magicTalent) {
                    spellstab.append('<br><div class="domaine"><b>Domaine de Magie:</b> ' + magicTalent.spec + '</div>');
                }
                var chaosMagicTalent = character.searchTalent('Magie du Chaos', '', false)
                if (chaosMagicTalent) {
                    spellstab.append('<br><div class="chaos_domaine"><b>Domaine du Chaos:</b> ' + chaosMagicTalent.spec + '</div>');
                }
                var spellsByGroup = {};
                $(spells).each(function (i, el) {
                    if (typeof spellsByGroup[el.data.type] === 'undefined') {
                        spellsByGroup[el.data.type] = [];
                    }
                    spellsByGroup[el.data.type][spellsByGroup[el.data.type].length] = el;
                });
                $(['Béni', 'Invocation', 'Magie mineure', 'Magie des Arcanes', 'Magie du Chaos']).each(function (i, label) {
                    if (typeof spellsByGroup[label] !== 'undefined') {
                        var el = spellsByGroup[label];
                        spellstab.append('<br><div><b>' + label + ':</b></div>');
                        Helper.generateListWithHelp(
                            el,
                            function () {
                                return true
                            },
                            spellstab,
                            function (i, el) {
                                return el.getLabel()
                            },
                            function (i, elem, dis, force) {
                                Helper.showPopin('', Helper.getHelpFormat(el[i].data), CharGen, force);
                            },
                            true
                        );
                    }
                });
                spellstab.find('.gods').on('click', function () {
                    Helper.showPopin('', Helper.getHelpFormat(god), CharGen)
                });
                spellstab.find('.domaine').on('click', function () {
                    Helper.showPopin('', Helper.getHelpFormat(CharGen.allLore[Helper.toId(magicTalent.spec)]), CharGen)
                });
                spellstab.find('.chaos_domaine').on('click', function () {
                    Helper.showPopin('', Helper.getHelpFormat(CharGen.allLore[Helper.toId(chaosMagicTalent.spec)]), CharGen)
                });
            }
            tabs.append('<div id="tabs-7" class="pretty_panel overflow_panel"><div class="main_div"><div class="left_panel"></div><div class="right_panel"></div></div></div>');
            var experience = tabs.find('#tabs-7 .left_panel');
            allDetails = [
                {
                    label: 'Expérience Actuelle',
                    value: character.xp.max - character.xp.tmp_used - character.xp.used,
                    desc: function () {
                    }
                },
                {
                    label: 'Expérience Dépensée', value: character.xp.tmp_used + character.xp.used, desc: function () {
                    }
                },
                {
                    label: 'Expérience Totale', value: character.xp.max, desc: function () {
                    }
                }
            ]
            $(allDetails).each(function (i, el) {
                experience.append('<div data-id="detail_xp' + i + '"><b>' + el.label + ':</b> ' + el.value + '</div><br>');
                $('[data-id="detail_xp' + i + '"]').off('click').on('click', function () {
                    el.desc();
                });
            });
            experience.append('<div class="gods"><b>Historique:</b></div>');
            for (let [labels, value] of Object.entries(character.xp.log)) {
                var label = labels.split('_');
                experience.append('<div>' + label[label.length - 1] + ' ' + value + 'xp</div>');
            }

            tabs.tabs();
            $('.validate').off('click');
            $('.validate').prop('disabled', character.stepIndex !== number || character.stepIndex === -1)
            if (character.stepIndex !== -1) {
                if (!$('.validate').prop('disabled')) {
                    $('.validate').on('click', function () {
                        $('.left_panel').addClass('overflow_panel');
                        $('.left_panel').addClass('pretty_panel');
                        character.stepIndex = -1;
                        CharGen.defaultAction.validate(oThat, number);
                    });
                }
            } else {
                $('.validate').css('visibility', 'hidden');
            }
        };
        return oThat;
    }
    this.StepResume = StepResume;
</script>